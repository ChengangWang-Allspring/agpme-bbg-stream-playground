@page "/settings"
@using Agpme.Bbg.Playground.Admin.Services
@inject SubscriptionsClient Api
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@using MudBlazor

<PageTitle>Settings</PageTitle>

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h5">Client Settings</MudText>

    <MudForm Class="mt-4">
        <MudTextField Label="as_of_date (yyyy-MM-dd)" @bind-Value="_asOf" Placeholder="empty = today" />
        <MudStack Row Spacing="2" Class="mt-2">
            <MudButton Color="Color.Primary" OnClick="Save">Save</MudButton>
            <MudButton Variant="Variant.Outlined" OnClick="Reload">Reload</MudButton>
        </MudStack>
    </MudForm>
</MudPaper>

<MudPaper Class="pa-4 mt-6">
    <MudText Typo="Typo.h6" Color="Color.Error">Danger Zone</MudText>
    <MudText Typo="Typo.body2" Class="mb-2">
        Reset both <code>bbg_positions_inbound</code> and <code>bbg_positions</code> tables.
        This action is destructive and cannot be undone.
    </MudText>

    <MudStack Row Spacing="2">
        <MudButton Color="Color.Error"
                   Variant="Variant.Filled"
                   StartIcon="@Icons.Material.Filled.DeleteForever"
                   OnClick="ConfirmAndReset">
            Reset inbound + positions
        </MudButton>
        <MudButton Color="Color.Primary"
                   Variant="Variant.Outlined"
                   StartIcon="@Icons.Material.Filled.Sync"
                   OnClick="ResyncMetadata">
            Resync metadata (DEV → Local)
        </MudButton>
    </MudStack>
</MudPaper>

@code {
    private string? _asOf;

    protected override async Task OnInitializedAsync() => await Reload();

    private async Task Reload() => _asOf = await Api.GetAsOfDateAsync();

    private async Task Save()
    {
        await Api.SetAsOfDateAsync(string.IsNullOrWhiteSpace(_asOf) ? null : _asOf!.Trim());
        Snackbar.Add("Saved.", Severity.Success);
    }

    private async Task ConfirmAndReset()
    {
        bool? yes = await DialogService.ShowMessageBox(
            title: "Confirm reset",
            markupMessage: (MarkupString)"This will <b>truncate</b> both tables and restart identities in the playground database. Continue?",
            yesText: "Reset",
            cancelText: "Cancel",
            options: new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall, FullWidth = true });

        if (yes == true)
        {
            try
            {
                await Api.ResetPositionsAsync();
                Snackbar.Add("Tables reset. You can re-run subscriptions now.", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Reset failed: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task ResyncMetadata()
    {
        try
        {
            var rows = await Api.ResyncInboundColsMapAsync();  // POST /client/metadata/inbound-cols-map/resync
            Snackbar.Add($"Metadata resynced from DEV. Rows copied: {rows}.", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Metadata resync failed: {ex.Message}", Severity.Error);
        }
    }
}