@page "/targets"
@using Agpme.Bbg.Playground.Admin.Services
@inject SubscriptionsClient Api
@inject ISnackbar Snackbar
@using MudBlazor

<PageTitle>Targets</PageTitle>

<MudPaper Class="pa-4">
    <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
        <MudText Typo="Typo.h5">Configured Targets</MudText>
        <MudSpacer />
        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="Reload">Refresh</MudButton>
    </MudStack>

    <MudTable Items="_targets" Hover="true" Dense="true" Class="mt-4">
        <HeaderContent>
            <MudTh>Entity</MudTh>
            <MudTh>Action</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@($"{context.entityType}/{context.entityName}")</MudTd>
            <MudTd>
                <MudButton Size="Size.Small" Color="Color.Primary"
                           OnClick="@(()=> Start(context.entityType, context.entityName))">
                    Start
                </MudButton>
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>No targets configured.</MudText>
        </NoRecordsContent>
    </MudTable>
</MudPaper>

@code {
    private List<SubscriptionsClient.Target>? _targets;

    protected override async Task OnInitializedAsync() => await Load();

    private async Task Load(CancellationToken ct = default)
        => _targets = await Api.GetTargetsAsync(ct);

    private async Task Reload() => await Load();

    private async Task Start(string entityType, string entityName)
    {
        await Api.StartAsync(new(entityType, entityName));
        Snackbar.Add($"Start requested for {entityType}/{entityName}.", Severity.Success);
    }
}