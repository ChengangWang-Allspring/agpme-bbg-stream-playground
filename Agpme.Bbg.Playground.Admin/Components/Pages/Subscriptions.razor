@page "/subscriptions"
@using Agpme.Bbg.Playground.Admin.Services
@using Agpme.Bbg.Playground.Admin.Models
@inject SubscriptionsClient Api
@inject ISnackbar Snackbar
@using MudBlazor

<PageTitle>Subscriptions</PageTitle>

<MudPaper Class="pa-4">

    <!-- Header: Title + As-Of Date controls -->
    <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
        <MudText Typo="Typo.h5">Subscriptions</MudText>
        <MudSpacer />
        <!-- DB status -->
        <MudChip T="string"
                 Color="@(_dbStatus == "online" ? Color.Success : Color.Error)"
                 Variant="Variant.Filled">
            <MudIcon Icon="@(_dbStatus == "online"
                     ? Icons.Material.Filled.Storage
                     : Icons.Material.Filled.Warning)"
                     Class="mr-1" />
            DB: @_dbStatus
        </MudChip>
        @if (!string.IsNullOrWhiteSpace(_dbError) && _dbStatus != "online")
        {
            <MudTooltip Text="@_dbError"><MudIcon Icon="@Icons.Material.Filled.Info" Class="ml-1" /></MudTooltip>
        }
        <!-- As‑of group (picker + Apply kept together) -->
        <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
            <MudDatePicker @bind-Date="_pickAsOf"
                           DateFormat="yyyy-MM-dd"
                           Label="As‑of"
                           Variant="Variant.Outlined"
                           Margin="Margin.Dense"
                           Clearable="true"
                           Placeholder="empty = today"
                           Style="width: 320px;" />
            <MudButton Variant="Variant.Filled"
                       Color="Color.Default"
                       OnClick="ApplyAsOfAsync">
                Apply
            </MudButton>

            <!-- Current as‑of shown as a subtle chip -->
            <MudChip T="string" Variant="Variant.Text" Color="Color.Info" Class="ml-1">
                as‑of: @(_asOfLabel ?? "(today)")
            </MudChip>
        </MudStack>

        <!-- Refresh All -->
        <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="Reload" Class="ml-4">Refresh</MudButton>
        <!-- Start All (uses configured targets) -->
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@(_dbStatus != "online")" OnClick="StartAll" Class="ml-2">
            Start All
        </MudButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="StopAll" Class="ml-2">Stop All</MudButton>
    </MudStack>

    <!-- Unified table -->
    <MudTable Items="_rows" Hover="true" Dense="true" Class="mt-4">
        <HeaderContent>
            <MudTh>
                <MudTableSortLabel T="RowVm" SortBy="@(x => x.EntityType + "/" + x.EntityName)">Entity</MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel T="RowVm" SortBy="@(x => x.Started)">Status</MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel T="RowVm" SortBy="@(x => x.LastMessageLocal)">Last Message</MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel T="RowVm" SortBy="@(x => x.Heartbeats)">Heartbeats</MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel T="RowVm" SortBy="@(x => x.Intraday)">Intraday</MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel T="RowVm" SortBy="@(x => x.Initial)">Initial</MudTableSortLabel>
            </MudTh>
            <MudTh>Action</MudTh>
        </HeaderContent>


        <RowTemplate>
            <MudTd>@($"{context.EntityType}/{context.EntityName}")</MudTd>
            <MudTd>
                @if (context.Started)
                {
                    <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                        <MudChip T="string" Color="Color.Success" Variant="Variant.Filled">
                            <MudIcon Icon="@Icons.Material.Filled.PlayArrow" Class="mr-1" />
                            Started
                        </MudChip>
                        <MudProgressCircular Indeterminate="true"
                                             Size="Size.Small" Color="Color.Success" />
                    </MudStack>
                }
                else
                {
                    <MudChip T="string" Color="Color.Default" Variant="Variant.Outlined">
                        <MudIcon Icon="@Icons.Material.Filled.Stop" Class="mr-1" />
                        Stopped
                    </MudChip>
                }
            </MudTd>
            <MudTd>@(context.LastMessageLocal ?? "-")</MudTd>
            <MudTd>@context.Heartbeats</MudTd>
            <MudTd>@context.Intraday</MudTd>
            <MudTd>@context.Initial</MudTd>
            <MudTd>
                @if (context.Started)
                {
                    <MudButton Size="Size.Small" Color="Color.Error" OnClick="@(() => Stop(new(context.EntityType, context.EntityName)))">
                        Stop
                    </MudButton>
                }
                else
                {
                    <MudButton Size="Size.Small" Color="Color.Primary" OnClick="@(() => Start(new SubscriptionKey(context.EntityType, context.EntityName)))">
                        Start
                    </MudButton>
                }
            </MudTd>
        </RowTemplate>

        <NoRecordsContent>
            <MudText>No subscriptions or targets found.</MudText>
        </NoRecordsContent>
    </MudTable>
</MudPaper>

@code {
    // ---------------- Page model ----------------
    private sealed record RowVm(
        string EntityType,
        string EntityName,
        bool Started,
        string? LastMessageLocal,
        int Heartbeats,
        int Intraday,
        int Initial
    );

    private List<RowVm> _rows = new();
    private DateTime? _pickAsOf;          // <-- DateTime? for the picker (null => today)
    private string? _asOfLabel;           // what API currently holds (or null => today)
    private string _dbStatus = "unknown";
    private string? _dbError;

    // ---------------- Life cycle ----------------
    protected override async Task OnInitializedAsync()
        => await Reload();

    private async Task Reload()
    {
        // DB health first
        var db = await Api.GetDbHealthAsync();
        _dbStatus = db.status;
        _dbError = db.error;

        // Pull current as_of_date label
        _asOfLabel = await Api.GetAsOfDateAsync();

        // Running subscriptions
        var running = await Api.ListAsync();

        // Configured targets
        var targets = await Api.GetTargetsAsync() ?? new();

        // Index running by key (entityType/entityName)
        var runningMap = running.ToDictionary(
            r => (r.Key.entityType, r.Key.entityName),
            r => r);

        // 1) Emit all running as Started
        var rows = new List<RowVm>(runningMap.Count + targets.Count);
        foreach (var r in running)
        {
            rows.Add(new RowVm(
                r.Key.entityType,
                r.Key.entityName,
                Started: true,
                LastMessageLocal: r.Metrics.LastMessageAt?.ToLocalTime().ToString("HH:mm:ss"),
                Heartbeats: r.Metrics.Heartbeats,
                Intraday: r.Metrics.IntradayObjects,
                Initial: r.Metrics.InitialPaintObjects
            ));
        }

        // 2) Emit any configured target not in running => Stopped
        foreach (var t in targets)
        {
            if (!runningMap.ContainsKey((t.entityType, t.entityName)))
            {
                rows.Add(new RowVm(
                    t.entityType,
                    t.entityName,
                    Started: false,
                    LastMessageLocal: null,
                    Heartbeats: 0,
                    Intraday: 0,
                    Initial: 0
                ));
            }
        }

        // (Optional) sort by status then name
        _rows = rows
            .OrderByDescending(r => r.Started) // Started first
            .ThenBy(r => r.EntityType)
            .ThenBy(r => r.EntityName, StringComparer.OrdinalIgnoreCase)
            .ToList();
    }

    // ---------------- Actions ----------------
    private async Task Start(SubscriptionKey key)
    {
        if (_dbStatus != "online")
        {
            Snackbar.Add("Local DB is offline. Start the Postgres Docker container first.", Severity.Error);
            return;
        }
        var res = await Api.StartAsync(key);
        if (res is not null)
            Snackbar.Add($"Start requested for {key.entityType}/{key.entityName}.", Severity.Success);
        await Reload();
    }

    private async Task Stop(SubscriptionKey key)
    {
        var ok = await Api.StopAsync(key);
        Snackbar.Add(ok ? "Stopped." : "Not running.", ok ? Severity.Info : Severity.Warning);
        await Reload();
    }

    private async Task StartAll()
    {
        if (_dbStatus != "online")
        {
            Snackbar.Add("Local DB is offline. Start the Postgres Docker container first.", Severity.Error);
            return;
        }
        await Api.StartAllAsync();
        Snackbar.Add("Start-all dispatched.", Severity.Success);
        await Reload();
    }

    private async Task StopAll()
    {
        // Get the current running list
        var running = await Api.ListAsync();
        if (running.Count == 0)
        {
            Snackbar.Add("No running subscriptions.", Severity.Info);
            return;
        }

        // Stop each running subscription
        int stopped = 0;
        foreach (var s in running)
        {
            var ok = await Api.StopAsync(new SubscriptionKey(s.Key.entityType, s.Key.entityName));
            if (ok) stopped++;
        }

        Snackbar.Add($"Stop-all requested: {stopped} stopped.", Severity.Success);
        await Reload(); // refresh the table
    }

    // Apply As-Of date: post yyyy-MM-dd or null to use "today"
    private async Task ApplyAsOfAsync()
    {
        // Convert DateTime? from picker to yyyy-MM-dd for API
        string? newVal = _pickAsOf.HasValue
            ? DateOnly.FromDateTime(_pickAsOf.Value.Date).ToString("yyyy-MM-dd")
            : null;

        var saved = await Api.SetAsOfDateAsync(newVal);
        _asOfLabel = saved; // show what the API accepted (null => today)
        Snackbar.Add($"as_of_date set to {(saved ?? "(today)")}.", Severity.Success);
    }
}